---
title: "Análisis del ruido en Madrid"
output: 
    html_notebook: default 
    html_document: default

---

Este notebook presenta un análisis del índice de ruido $LA_{eq}^{(i)}$ en la ciudad de Madrid para los años 2015-2019, ambos incluidos, y el año 2020 hasta el mes de mayo. 

(1) En la primera parte se presentan los datos en bruto para las 31 estaciones presentes en la capital. Observaremos que 

(2) En la segunda parte, compararemos la evolución de la media mensual del índice $LA_{eq}$ para las distintas estaciones, permitiéndonos observar un claro descenso en el año 2020 debido a las medidas de aislamiento debidas a la pandemia producida por el COVID-19. Posteriormente, descenderemos a una escala diaria para analizar en detalle el efecto de las distintas etapas del aislamiento sobre el ruido registrado en las distintas estaciones. 


i El índice de ruido $LA_{eq}$ es el parámetro acústico aceptado internacionalmente como medida del nivel sonoro continuo equivalente. Este índice representa la contaminación acústica acumulada a lo largo de un periodo de tiempo en el lugar de medición. Puesto que el oído humano es más sensible a las medias frecuencias, se realiza una ponderación de frecuencias, dando menos importancia a las bajas y altas frecuencias frente a las medias, con el fin de establecer una medida del nivel de ruido que soporta el ser humano cercano a la estación de medición. 


Análisis realizado por @ClaudiaGues y [@ddzumajo](https://github.com/ddzumajo)


Datos: Los datos han sido obtenido del [Portal de datos abiertos del Ayuntamiento de Madrid](https://datos.madrid.es/portal/site/egob/menuitem.c05c1f754a33a9fbe4b2e4b284f1a5a0/?vgnextoid=2ec892874870b410VgnVCM1000000b205a0aRCRD&vgnextchannel=374512b9ace9f310VgnVCM100000171f5a0aRCRD&vgnextfmt=default).

```{r}
library("dplyr")
library("ggplot2")
library('gridExtra')
```

```{r}
Sys.setlocale("LC_TIME", "en_US.UTF-8")
```

```{r}
df <- read.csv(file = './data/datos_ruido_madrid.csv', header = FALSE, sep = ';', strip.white = TRUE)
dfs <- read.csv(file = './data/EstacionesMedidaControlAcustico.csv', header = FALSE, sep = ';', strip.white = TRUE, fileEncoding = "ISO-8859-1")

colnames(df) <- c("Station","Year","Month","Day","Period","LAeq","LAS01","LAS10","LAS50","LAS90","LAS99")

df$Date <- as.Date(with(df, paste(Year, Month, Day,sep="-")), "%Y-%m-%d")

df$MonthName <- months(df$Date)

df$DayMonthName <- with(df, paste(weekdays(df$Date), MonthName,sep="-"))

df$LAS01 <- NULL
df$LAS10 <- NULL
df$LAS50 <- NULL
df$LAS90 <- NULL
df$LAS99 <- NULL


head(df)
```

```{r}

dfs <- read.csv(file = './data/EstacionesMedidaControlAcustico.csv', header = TRUE, sep = ',', strip.white = TRUE, fileEncoding = "ISO-8859-1")

dfs[ ,c('COD_VIA', 'VIA_CLASE','VIA_PAR','VIA_NOMBRE','Dirección','Longitud_gms','Latitud_gms','LATITUD_ED50','LONGITUD_ED50','Alt..m.','Fecha.alta','Coordenada_X_ETRS89','Coordenada_Y_ETRS89','LONGITUD_WGS84','LATITUD_WGS84','X.2','X.3')] <- list(NULL)

dfs <- dfs %>% 
  rename(
    Station=Nº,
    StationName = Nombre,
    Long = X, 
    Lat = X.1
    )

head(dfs)

```


```{r}
df <- merge(df, dfs, by = "Station", all.x = TRUE)
head(df)

```


Calculamos la media de los índices por año, mes, estación y periodo, y añadimos las variables al dataframe.

```{r}

meanLAeqByMonthStationAndPeriod <- df %>% 
    group_by(Year,MonthName, StationName, Period) %>% 
    summarise(meanLAeqByMonth = mean(LAeq))

df <- merge(df, meanLAeqByMonthStationAndPeriod, by = c("Year","MonthName", "StationName", "Period"), all.x = TRUE)

colnames(df)

head(df)
```

Nos centramos únicamente en el índice LAeq durante el periodo 'T'. Nos interesa conocer la media mensual por año de ese índice para cada una de las estaciones de Madrid. 

```{r}
 dfPeriodT <- df %>% filter(Period == "T")

dfMeanLAeqByMonth <- distinct(dfPeriodT, Year, MonthName, StationName, meanLAeqByMonth)

# Year as factor in order to facilitate the choice of colors in the plot
dfMeanLAeqByMonth$Year <- factor(dfMeanLAeqByMonth$Year)

```





```{r, fig.width=12, fig.height=8}

ggplot(dfMeanLAeqByMonth, aes(x = ordered(MonthName,levels=month.name), y = meanLAeqByMonth, group=Year)) +
  geom_point(aes(color=Year), size=2)  +
  geom_line(aes(color=Year))  +
  facet_wrap(~ StationName, ncol = 3, scales="free") +
  labs(title = "Comparación del índice LAeq medido en las distintas estaciones a lo largo de los años",
       subtitle = "Se ha realizado la media mensual de los datos recopilados en cada una de las estaciones",
       y = "Media mensual LAeq") +
 theme(legend.position="top")
```

Una vez que hemos visto cómo el efecto de la cuarentena debido al coronavirus se refleja en los niveles de ruido, nos centramos únicamente en el periodo de tiempo durante el cual fueron aplicadas las medidas de confinamiento e hibernación de la economía. Para ello estudiaremos los niveles de ruido con un nivel de descripción semanal. 

Para ello crearemos obtendremos los promedios diarios de los índices de los años 2015-2019 teniendo en cuenta las siguientes premisas: 

1. Los promedios se tienen que realizar no por fecha sino por días (i.e. se promedian los días de la semana de un mismo mes). Así pues, tomaremos, por ejemplo, todos los lunes de un mismo mes de los distintos años para realizar el promedio y obtener un lunes "típico" del mes en cuestión. 

2. Construiremos un mes "típico" para compararlo con el mes correspondiente de 2020. 

3. El efecto de Madrid central observado en la gráfica anterior no va a ser tenido en cuenta ya que vamos a promediar sobre todos los años previos al de la crisis del coronavirus. 
```{r}
head(df)
```

Calculamos la media por día del mes para todos los años comprendidos entre 2015 y 2019 (ambos incluidos).

```{r}

 df_2015_2019<- df %>% filter(Year!=2020)

 meanLAeqByDayMonthStationAndPeriod_2015_2019 <- df_2015_2019 %>%
  group_by(DayMonthName, StationName, Period) %>% 
  summarise(meanLAeqByDayMonth_2015_2019 = mean(LAeq))

head(meanLAeqByDayMonthStationAndPeriod_2015_2019)
```

Creamos el dataframe para el año 2020 y añadimos el resultado de la media del índice LAeq promediada por tipo de día del mes. Cortamos el dataframe para quedarnos únicamente con los días comprendidos entre los meses marzo-mayo, ambos incluidos. Además, solo nos interesa el Periodo 'T'. 
```{r}

df2020 <- df %>% filter(Year==2020) %>% filter(Period=='T')

dfCovidEffect <- merge(df2020, meanLAeqByDayMonthStationAndPeriod_2015_2019, by= c("DayMonthName", "StationName", "Period"), x.ALL = True)

dfCovidEffect <- dfCovidEffect %>% filter(Month>2, Month<6) 

dfCovidEffect <- dfCovidEffect[, c('Date', 'StationName','LAeq', 'meanLAeqByDayMonth_2015_2019')]

colnames(dfCovidEffect) <- c("Date","StationName","LAeq_2020","LAeq_2015_2019")


head(dfCovidEffect)

```

```{r}

dfCovidEffectMelted <- reshape2::melt(dfCovidEffect, id.var=c('Date', 'StationName'))

head(dfCovidEffectMelted)
```

```{r}

colnames(dfCovidEffectMelted)[3] <- "LAeq"

```


```{r, fig.width=12, fig.height=8}

ggplot(dfCovidEffectMelted, aes(x = Date, y = value, col=LAeq)) +
  geom_point(color='black',size=1)  +
  geom_line()  +
  geom_rect(aes(xmin = as.Date("2020-03-16"), xmax = as.Date("2020-03-30"),ymin = -Inf, ymax = Inf),
                   fill = "green", alpha = 0.002) +
  geom_rect(aes(xmin = as.Date("2020-03-30"), xmax = as.Date("2020-04-13"),ymin = -Inf, ymax = Inf),
                   fill = "red", alpha = 0.002) +
  geom_rect(aes(xmin = as.Date("2020-04-13"), xmax = as.Date("2020-04-26"),ymin = -Inf, ymax = Inf),
                   fill = "green", alpha = 0.002) +
  facet_wrap(~ StationName, ncol = 3, scales="free") +
  labs(title = "Comparación del índice de ruido LAeq diario para 2020 y la media de los años 2015-2019",
       subtitle = "(La media de los años 2015-2019 ha sido calculada para obtener una semana 'tipo')", y = "LAeq") +
 theme(legend.position="top")
```

